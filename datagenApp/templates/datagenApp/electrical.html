{% extends 'datagenApp/base.html' %}
{% load static %}
{% block title %}Data Generator{% endblock title %}
{% block content %}

<!-- One "tab" for each step in the form: -->
<div class="tab mt-5">
  <div
    class="left_portion col-12 col-sm-6 col-md-6 col-lg-4 col-xl-4 shadow bg-body-tertiary rounded mx-auto p-5 mb-5 mt-5"
  >
    <div class="row my-2">
      <div class="col-12 text-center border border-secondary border-2">
        <h2>Electrical Data</h2>
      </div>
    </div>
    <div class="row my-3">
      <div class="select col-12 col-sm-6 col-md-6 col-lg-8 col-xl-8 m-0 p-0">
        <select class="form-select form-select-sm" aria-label="Default select example" id="e_comboBox">
          <option selected>--Select--</option>
          <option value="ICCID">ICCID</option>
          <option value="IMSI">IMSI</option>
          <option value="PIN1">PIN1</option>
          <option value="PUK1">PUK1</option>
          <option value="PIN2">PIN2</option>
          <option value="PUK2">PUK2</option>
          <option value="KI">KI</option>
          <option value="EKI">EKI</option>
          <option value="OPC">OPC</option>
          <option value="ADM1">ADM1</option>
          <option value="ADM1">ADM6</option>
          <option value="ACC">ACC</option>
          <!-- Additional options -->
        </select>
      </div>
      <div class="btns col-12 col-sm-6 col-md-6 col-lg-4 col-xl-4 mt-2 mt-sm-0">
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-sm btn_icons" id="e_add_text" title="Add Parameter">
            <i class="fas fa-plus-circle"></i>
          </button>
          <button type="button" class="btn btn-sm btn_icons" id="e_del_text" title="Delete Parameter">
            <i class="fas fa-minus-circle"></i>
          </button>
          <button type="button" class="btn btn-sm btn_icons" id="e_default" title="Set Default Parameters">
            <i class="fas fa-sync"></i>
          </button>
          <button type="button" class="btn btn-sm btn_icons" id="e_save" title="Save Parameters">
            <i class="fas fa-sd-card"></i>
          </button>
          <!-- Additional buttons -->
        </div>
      </div>
    </div>
    <div class="row table-wrap border border-1 mt-3">
      <table class="table table-striped table-hover" id="data_table">
        <thead>
          <tr>
            <th scope="col">S#</th>
            <th scope="col">Parameter</th>
            <th scope="col">L Clip</th>
            <th scope="col">R Clip</th>
          </tr>
        </thead>
        <tbody id="e_tableWidget">
          <!-- Table rows will be inserted here -->
        </tbody>
      </table>
    </div>
    <!---Electrical Part End-->
  </div>

  <a class="btn btn-secondary btn-sm" href="{% url 'keys' %}">Back</a>
  <a class="btn btn-primary btn-sm" href="{% url 'graphical' %}">Next</a>
</div>

<script>
  const defaultData = [
    { id: 1, variable: 'ICCID', clip: '0', length: '19' },
    { id: 2, variable: 'IMSI', clip: '0', length: '14' },
    { id: 3, variable: 'PIN1', clip: '0', length: '3' },
    { id: 3, variable: 'PUK1', clip: '0', length: '3' },
    { id: 3, variable: 'PIN2', clip: '0', length: '3' },
    { id: 3, variable: 'PUK2', clip: '0', length: '3' },
    { id: 3, variable: 'KI', clip: '0', length: '31' },
    { id: 3, variable: 'EKI', clip: '0', length: '31' },
    { id: 3, variable: 'OPC', clip: '0', length: '31' },
    { id: 3, variable: 'ADM1', clip: '0', length: '3' },
    { id: 3, variable: 'ADM6', clip: '0', length: '3' },
    { id: 3, variable: 'ACC', clip: '0', length: '3' }
  ];

  document.getElementById('e_add_text').addEventListener('click', addRowFromDefault);
  document.getElementById('e_del_text').addEventListener('click', deleteRow);
  document.getElementById('e_default').addEventListener('click', loadDefaultData);
  document.getElementById('e_save').addEventListener('click', saveData);

  function addRowFromDefault() {
    const comboBox = document.getElementById('e_comboBox');
    const selectedValue = comboBox.value;
    const data = defaultData.find(item => item.variable === selectedValue);

    if (!data) {
      alert('Please select a valid option.');
      return;
    }

    const table = document.getElementById('e_tableWidget');
    const row = table.insertRow();
    row.onclick = function() { selectRow(this); };
    row.innerHTML = `
      <td>${table.rows.length}</td>
      <td>${data.variable}</td>
      <td>${data.clip}</td>
      <td>${data.length}</td>
    `;
  }

  function deleteRow() {
    const table = document.getElementById('e_tableWidget');
    Array.from(table.rows).forEach(row => {
      if (row.classList.contains('selected')) {
        table.deleteRow(row.rowIndex - 1);
      }
    });
  }

  function loadDefaultData() {
    const table = document.getElementById('e_tableWidget');
    table.innerHTML = ''; // Clear existing table data
    defaultData.forEach(data => {
      const row = table.insertRow();
      row.innerHTML = `
        <td>${data.id}</td>
        <td>${data.variable}</td>
        <td>${data.clip}</td>
        <td>${data.length}</td>
      `;
      row.onclick = function() { selectRow(this); };
    });
  }

  function selectRow(row) {
    const selected = document.querySelector('.selected');
    if (selected) selected.classList.remove('selected');
    row.classList.add('selected');
  }


function saveData() {
    const table = document.getElementById('e_tableWidget');
    const rows = Array.from(table.rows);
    const data = rows.map((row, index) => {
        const cells = row.cells;
        return {
            id: index + 1, 
            variable: cells[1].textContent,
            clip: cells[2].textContent,
            length: cells[3].textContent
        };
    });

    fetch("{% url 'save_data' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // Ensure CSRF token is sent
        },
        body: JSON.stringify(data)
    }).then(response => response.json())
      .then(data => {
          console.log('Success:', data);
      })
      .catch((error) => {
          console.error('Error:', error);
      });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>

{% endblock content %}
